<!doctype html><html lang=en><head><title>利用nginx变通的解决跨域问题 · 人渣29的小窝</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Harry Wang"><meta name=description content="变通的解决跨域问题"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="利用nginx变通的解决跨域问题"><meta name=twitter:description content="变通的解决跨域问题"><meta property="og:title" content="利用nginx变通的解决跨域问题"><meta property="og:description" content="变通的解决跨域问题"><meta property="og:type" content="article"><meta property="og:url" content="https://harrywang29.github.io/tech/%E5%88%A9%E7%94%A8nginx%E8%BF%9B%E8%A1%8C%E9%A1%B5%E9%9D%A2%E4%B8%8E%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%88%86%E6%B5%81/"><meta property="article:section" content="tech"><meta property="article:published_time" content="2022-08-26T22:11:20+08:00"><meta property="article:modified_time" content="2022-08-26T22:11:20+08:00"><link rel=canonical href=https://harrywang29.github.io/tech/%E5%88%A9%E7%94%A8nginx%E8%BF%9B%E8%A1%8C%E9%A1%B5%E9%9D%A2%E4%B8%8E%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%88%86%E6%B5%81/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.c4d7e93a158eda5a65b3df343745d2092a0a1e2170feeec909b8a89443903c6a.css integrity="sha256-xNfpOhWO2lpls980N0XSCSoKHiFw/u7JCbiolEOQPGo=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.39e41a7f16bdf8cb16e43cae7d714fa1016f1d2d2898a5b3f27f42c9979204e2.css integrity="sha256-OeQafxa9+MsW5DyufXFPoQFvHS0omKWz8n9CyZeSBOI=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.102.1"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>人渣29的小窝</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/tech/>tech</a></li></ul></section></nav><div class=content><section class="container page"><article><header><h1 class=title><a class=title-link href=https://harrywang29.github.io/tech/%E5%88%A9%E7%94%A8nginx%E8%BF%9B%E8%A1%8C%E9%A1%B5%E9%9D%A2%E4%B8%8E%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%88%86%E6%B5%81/>利用nginx变通的解决跨域问题</a></h1></header><h2 id=背景>背景
<a class=heading-link href=#%e8%83%8c%e6%99%af><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>支付宝商家会员卡业务有两种开卡方式（此处不考虑最新的spi方式）</p><ul><li>支付宝app扫投放链接获取会员卡</li><li>支付宝小程序通过会员卡参数直接拉起小程序开卡组件</li></ul><p>这两个方式在用户填写<code>表单</code>之后都会向指定<code>回调地址</code>中发送一个<code>get</code>请求，并等待成功返回</p><p>如果为了兼容上面两种开卡方式，最优选择应该是后端接收到支付宝的<code>get</code>请求后，通过<code>out_string</code>判断是由什么渠道发起的</p><ul><li>若浏览器发起，在开卡业务完成后，返回<code>301/302</code>重定向应答，让支付宝app重定向到一个前端页面进行展示</li><li>若小程序发起，则返回应答成功的业务报文即可</li></ul><p>可是目前我们后端框架暂时无法支持向前端返回<code>301/302</code>这种重定向应答，于是我们暂时只支持了小程序开卡方式</p><p>一天支付宝业务人员突然说，他们需要h5扫码方式开会员卡，印刷并张贴在商户门店中，做一些运营活动，很突然，并且当天就要，还要app端跳转到卡包中，于是有了后面的一些操作</p><h2 id=解决方案>解决方案
<a class=heading-link href=#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><h3 id=难点>难点
<a class=heading-link href=#%e9%9a%be%e7%82%b9><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>如上文所说，我们后端并不支持返回<code>301/302</code>应答码，同时也不能导致支付宝小程序发卡失败，那么我们就只有一个方法解决问题，分成两个步骤：</p><ol><li>写一个中转页面，在h5模式下，支付宝app会解析html页面，于是中转页面中不需要有任何的界面，业务也比较简单</li></ol><ul><li>获取<code>get</code>请求中的<code>query</code>参数</li><li>将参数作为<code>get</code>参数发送给后端</li><li>获取请求结果</li><li>若应答成功，<code>herf</code>到指定<code>scheme_url</code>中</li></ul><ol start=2><li>由于紧急，并且公司内部的一些原因，要在公司主域名下发这个中转页面变得不太现实，于是引发了另外一个问题，<strong>跨域</strong></li></ol><h3 id=解决>解决
<a class=heading-link href=#%e8%a7%a3%e5%86%b3><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><ol><li>解决第一个问题非常方便，找了个前端，花几分钟完成了核心代码，一个html文件解决</li><li>第二个问题曾一度陷入死胡同，最后一句闲聊启发了我，为了避免跨域，html只能向自己域发起请求，那么我只需要找个东西在html的域下把<code>get</code>请求转发到后端就可以了，查阅了文档后，直接使用nginx即可做到<pre tabindex=0><code class=language-conf data-lang=conf>  location /ali {
    #判断$query_string中是否有web标识
    if ( $query_string ~* &#34;.*ali_web_redirect.*&#34; ) {
      #有web标识，则跳转到中转页面
        return 301 https://$http_host/redirect/redirect.html?$query_string;
    }

    #没有则直接向后端发送请求
    proxy_pass https://www.host.com/api/member/open/alipay/opencard;
  }

  location /redirect/ {
    root /opt/www/ali-redirect;
    index index.html index.htm;
  }
  #这个是中转页面发起的请求，此域名收到后，会转发到公司后端
  location ^~ /api/ {
    proxy_pass https://www.host.com;
  }
</code></pre></li></ol></article></section></div><footer class=footer><section class=container>©
2022
Harry Wang
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.236049395dc3682fb2719640872958e12f1f24067bb09c327b233e6290c7edac.js integrity="sha256-I2BJOV3DaC+ycZZAhylY4S8fJAZ7sJwyeyM+YpDH7aw="></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JS09HCGHMW"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-JS09HCGHMW",{anonymize_ip:!1})}</script></body></html>